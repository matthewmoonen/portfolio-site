<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add entry</title>
    <style>
        body {
            background-color: #121212; 
            color: #ffffff; 
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        form {
            background-color: #17191A;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        input, textarea {
            width: 70vw;
            background-color: #202428;
            color: #ffffff; 
            border: 1px solid #444444;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 10px;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #76c7c0;
        }

        button {
            background-color: #76c7c0; 
            color: #121212; 
            border: none;
            border-radius: 4px;
            padding: 10px 20px;
            cursor: pointer;
        }

        button:hover {
            background-color: #64b2ab; 
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        #md-div {
            width: 71vw;
        }

        .reference {
        font-weight: bold;
        color: #76c7c0; /* Highlighted color */
        font-size: 0.9em; /* Slightly smaller than the filename */
    }

    .copy-btn {
        background-color: #76c7c0;
        color: #121212;
        border: none;
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 0.8em;
    }

    .copy-btn:hover {
        background-color: #64b2ab;
    }

    .filename {
        display: inline-block;
        width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
    }

    .extension {
        font-style: italic;
        color: #aaa; /* Light gray color to make it less prominent */
    }


    </style>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/simplemde.min1.css') }}">
</head>
<body>
    <form method="POST" action="{{ url_for('add_entry') }}">
        <label for="title">Title</label>
        <input required type="text" id="title" name="title">
    
        <label for="blurb">Blurb</label>
        <textarea id="blurb" name="blurb" rows="1"></textarea>
    
        <label for="body">Body</label>
        <div id="md-div">
            <textarea id="body" name="body"></textarea>
        </div>
    
        <label for="img-upload">Add Images</label>
        <input type="file" id="img-upload" name="img-upload" multiple>
        <button type="button" id="upload-btn">Upload Images</button>
    
        <ul id="uploaded-images"></ul>
    
        <label for="slug">Slug</label>
        <input type="text" id="slug" name="slug">
    
        <label for="tags">Tags (comma-separated)</label>
        <input type="text" id="tags" name="tags">
    
        <button type="submit">Submit</button>
    </form>

    <script>
        const uploadBtn = document.getElementById('upload-btn');
        const imgUpload = document.getElementById('img-upload');
        const uploadedImagesList = document.getElementById('uploaded-images');
    
        // Handle image uploads
        uploadBtn.addEventListener('click', () => {
            const formData = new FormData();
            for (let file of imgUpload.files) {
                formData.append('images', file);
            }
    
            fetch('/upload_images', {
                method: 'POST',
                body: formData,
            })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    imgUpload.value = '';
                    refreshImageList(); // Refresh the entire image list after upload
                } else {
                    alert(data.error);
                }
            });
        });
    
        // Refresh the entire image list
        function refreshImageList() {
            fetch('/get_uploaded_images')
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        updateUploadedImages(data.images);
                    }
                });
        }

        





        function updateUploadedImages(images) {
    uploadedImagesList.innerHTML = ''; // Clear existing images
    images.forEach((image) => {
        const li = document.createElement('li');

        // Create a span for the reference (non-editable)
        const refSpan = document.createElement('span');
        refSpan.textContent = `[${image.id}]`; // Display the reference in brackets
        refSpan.className = 'reference';
        refSpan.style.marginRight = '10px';

        // Add a button to copy the full image URL
        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'Copy';
        copyBtn.className = 'copy-btn';
        copyBtn.type = 'button'; // Ensure it’s a regular button
        copyBtn.style.marginRight = '10px';
        copyBtn.onclick = () => {
            const siteUrl = window.location.origin; // Get the current site's base URL
            const imageUrl = `![](${siteUrl}/images/${image.id}.${image.extension})`; // Construct the image URL

            navigator.clipboard.writeText(imageUrl).then(() => {
                // Show confirmation message
                const confirmation = document.createElement('span');
                confirmation.textContent = 'Copied!';
                confirmation.style.color = 'green';
                confirmation.style.marginLeft = '5px';
                confirmation.className = 'copy-confirmation';

                // Add the confirmation message next to the button
                li.insertBefore(confirmation, copyBtn.nextSibling);

                // Remove the confirmation message after 2 seconds
                setTimeout(() => {
                    confirmation.remove();
                }, 2000);
            }).catch((err) => {
                console.error('Failed to copy URL: ', err);
            });
        };

        // Create a span for the filename (editable)
        const filenameSpan = document.createElement('span');
        filenameSpan.textContent = image.filename;
        filenameSpan.className = 'filename'; // Apply the CSS class
        filenameSpan.title = 'Click to edit filename';
        filenameSpan.onclick = () => makeEditable(filenameSpan, image.id);

        // Create a span for the file extension (non-editable)
        const extensionSpan = document.createElement('span');
        extensionSpan.textContent = `.${image.extension}`;
        extensionSpan.className = 'extension';
        extensionSpan.style.marginLeft = '5px';
        extensionSpan.style.color = '#aaa';

        // Add image preview
        const imgElement = document.createElement('img');
        imgElement.src = `/images/${image.id}.${image.extension}`;
        imgElement.alt = `${image.filename}.${image.extension}`;
        imgElement.style.maxWidth = '100px';
        imgElement.onerror = () => console.error(`Failed to load image: /images/${image.id}.${image.extension}`);

        // Add delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'x';
        deleteBtn.type = 'button'; // Ensure it’s a regular button
        deleteBtn.onclick = () => deleteImage(image.id);

        // Append elements to list item
        li.appendChild(refSpan);       // Add reference
        li.appendChild(copyBtn);      // Add copy button
        li.appendChild(filenameSpan); // Add filename
        li.appendChild(extensionSpan); // Add extension
        li.appendChild(imgElement);   // Add image preview
        li.appendChild(deleteBtn);    // Add delete button

        // Add the list item to the list
        uploadedImagesList.appendChild(li);
    });
}



function makeEditable(span, refId) {
    const currentFilename = span.textContent;

    // Replace span with an input field
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentFilename;
    input.style.width = '300px'; // Match the filename width
    input.style.marginRight = '10px';

    // Replace span with input in the DOM
    span.replaceWith(input);

    // Focus the input and select the text
    input.focus();
    input.select();

    // Save on blur or Enter key
    const saveFilename = () => {
        const newFilename = input.value.trim();
        if (newFilename && newFilename !== currentFilename) {
            fetch(`/update_image_filename/${refId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: newFilename }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        input.replaceWith(span);
                        span.textContent = newFilename; // Update to new filename
                    } else {
                        // Revert to the original filename on duplicate detection
                        input.replaceWith(span);
                        span.textContent = data.original_filename;
                    }
                });
        } else {
            input.replaceWith(span); // Revert if no change
        }
    };

    input.addEventListener('blur', saveFilename);
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            saveFilename();
        } else if (e.key === 'Escape') {
            input.replaceWith(span); // Revert on Escape
        }
    });
}

    
        // Handle image deletion
        function deleteImage(refId) {
            fetch(`/delete_image/${refId}`, { method: 'POST' })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        refreshImageList(); // Refresh the list after deletion
                    } else {
                        alert(data.error);
                    }
                });
        }
    
        // Load images on page load
        document.addEventListener('DOMContentLoaded', () => {
            refreshImageList();
        });
    </script>
    

















    
    <script src="{{ url_for('static', filename='js/simplemde.min.js') }}"></script>
    <script>
        var simplemde = new SimpleMDE({ 
            element: document.getElementById("body"), 
            spellChecker: false,
            
        });
    </script>
    
</body>
</html>
